---
title: "qPCR Analysis"
output: html_document
---

# Load and convert rawdata from LC480

```{r loaddata, include=FALSE}

library(qpcR)
library(HTqPCR)
library(tibble)
library(readr)
library(dplyr)
library(openxlsx)
library(ggplot2)

## GENERAL

# Sample1 , Sample2, Sample3 and Sample4 are used as generic placeholders
# this needs to be renamed in interface to the actual sample name, and then replaced in the Dataset

# ##Inputs:
# sample list (will be calculated from XLSX file below)
samplelist <- list("1" = "Sample1", "2" = "Sample2", "3" = "Sample3", "4" = "Sample4")

# type of Cq calculation method
## must be one of: cpD2 (default), cpD1 or Cy0
cq_calc_method = "Cy0"

# was a robot used to pipet the plate?
robot <- TRUE

# cQ filter
filterhigh <- 35
filterlow <- 5

# Target gene used as calibrator
calibrator <- "GAPDH"

#qPCR rawdata
file <- "/Users/janwinter/OneDrive/PhD/Followup/Results/qPCR/2017-03-20_TEST_Primers/data/JW_20170321_qPCR_TestPrimer.txt"


# XSLX overview file
file_xlsx <- "/Users/janwinter/OneDrive/PhD/Followup/Results/qPCR/2017-03-20_TEST_Primers/2017-03-20_qPCR_TEST_cDNASynthesis.xlsx"

# read file data 
file.read <- readr::read_tsv(file = file, col_names = c("SamplePos","SampleName","Prog","Seg","Cycle","Time","Temp","483-533"), skip = 2)
# make A1 to A01 to be consistent
#pattern <- expression("^(\\w{1})(\\d{1})$")
#file.read$SamplePos <- sub(pattern = pattern, replacement = paste("\\1","0","\\2", sep=""), x=  file.read$SamplePos, fixed = FALSE )

# convert to qpcR format flat file
## each row -> CYCLE
## each column -> Well
df.pcr <- NULL
## make new tibble with maximum number of cycles
df.pcr <- tibble::tibble("Cycles" = seq(from = min(file.read[,"Cycle"]), to = max(file.read[,"Cycle"]), by =1))

## Add names (unique ones of course) as columns, so we first make data frame for each Well that contains cycles 1-x and the 483-533 value
wells <- NULL

wells <- as.list(unique(file.read$SamplePos))
names(wells) <- unique(file.read$SamplePos)

#dplyr::filter(file.read, SamplePos == "A1" & Prog == 2)  %>% dplyr::select(2,3, 5, 8)

df.data <- lapply(wells, function(x){
  # get subset
  subset <- dplyr::filter(file.read, SamplePos == as.character(x) & Prog == 2)  %>% dplyr::select( 5, 8)
  # Get column 483-533
  #subset <- dplyr::select(subset, 5, 8)
  colnames(subset) <- c("Cycles",as.character(x))
  # Add to tibble
  df.pcr <<- dplyr::left_join(df.pcr, subset, by = "Cycles")
  return(subset)
  
})

df.data <- NULL
# df.pcr will store all information in a flat-file way for qPCR anakysis
# rows -> cycles
# columns <- wells
ncol(df.pcr)



## get melting curve information (Prog == 3 in data)
df.melting <- tibble::tibble("Temp" = unique(file.read[file.read$Prog == 3, "Temp"]$Temp))
#t <- dplyr::filter(file.read, SamplePos == "A1" & Prog == 3)  %>% dplyr::select( 7, 8)
#df.melting <<- dplyr::left_join(df.melting, t, by = "Temp")


df.data <- lapply(wells, function(x){
  # get subset
  subset <- dplyr::filter(file.read, SamplePos == as.character(x) & Prog == 3)  %>% dplyr::select( 7, 8)
  # Get column 483-533
  #subset <- dplyr::select(subset, 5, 8)
  colnames(subset) <- c("Temp", as.character(x))
  # Add to tibble
  df.melting <<- dplyr::left_join(df.melting, subset, by = "Temp")
  return(subset)
  
})


## AVAILABLE DATA STRUCTURES
# file.read -> qPCR raw data
# df.pcr -> flat-file qPCR rawdata in qpcR format
# df.melting -> flat-file qPCR melting curve data (temp vs fluorescence)

# load annotation data
if(robot)
{
  xlsx_mastermix <- openxlsx::read.xlsx(file_xlsx, sheet = "Mastermix")
  xlsx_primer <- openxlsx::read.xlsx(file_xlsx, sheet = "cDNA")
  xlsx_overview <- as.data.frame(openxlsx::read.xlsx(file_xlsx, sheet = "qPCR Overview", colNames = TRUE, rowNames = TRUE), stringsAsFactors = FALSE)
} else {
  xlsx_overview <- as.data.frame(openxlsx::read.xlsx(file_xlsx, sheet = "qPCR Overview", colNames = TRUE, rowNames = TRUE), stringsAsFactors = FALSE)
}

# get Overview plate first

overview_plate <- list()
overview_plate$overview <- reshape2::melt(as.matrix(xlsx_overview))
pattern <- expression("^(\\d{1})$")
#overview_plate$overview$Var2 <- sub(pattern = pattern, replacement = paste("0","\\1", sep=""), x=  overview_plate$overview$Var2, fixed = FALSE )
overview_plate$overview$position <- paste0(overview_plate$overview$Var1, overview_plate$overview$Var2)

platemap <- dplyr::mutate(as.data.frame(overview_plate$overview),
                   Row=as.numeric(match(toupper(substr(position, 1, 1)), LETTERS)),
                   Column=as.numeric(substr(position, 2, 5)))

# Replace Sample with user names
# Replace Sample by stoff from List that user gives
  
  samplelist <- list()
  if(!robot)
  {
    samplelist <- as.list(unique(overview_plate$overview$value))
    names(samplelist) <- unique(overview_plate$overview$value)
  } else {
    samplelist <- as.list(unique(xlsx_mastermix$Sample))
    names(samplelist) <- unique(xlsx_mastermix$Sample)
    
    # name will stay old, but character will be the new name
  
    for(i in 1:length(samplelist))
   {
      xlsx_mastermix$Sample <- sub(pattern = names(samplelist)[i],replacement = samplelist[[i]],x = xlsx_mastermix$Sample)
      xlsx_primer$Sample <- sub(pattern = names(samplelist)[i],replacement = samplelist[[i]],x = xlsx_primer$Sample)
    }
  }

  


## make ggplot2 image ov overview plate
  plot_platemap_overview <- function(data=NA){
   g <- ggplot2::ggplot(data=data, aes(x=Column, y=Row)) +
    geom_point(data=expand.grid(seq(1, 24), seq(1, 16)), aes(x=Var1, y=Var2),
               color="grey90", fill="white", shape=21, size=6) +
    geom_point(aes(color=value), size=6) +
    coord_fixed(ratio=(26/24)/(18/16), xlim=c(0.5, 25), ylim=c(0.5, 17)) +
    scale_y_reverse(breaks=seq(1, 16), labels=LETTERS[1:16]) +
    scale_x_continuous(breaks=seq(1, 24)) +
  scale_shape_manual(values=seq(from=0, to = length(unique(platemap$value)), by=1 ) ) +
    labs(title="Overview plate") 
   
   print(g)
  }




  
  ### Get info from cDNA and Mastermix plate for Overview the robot is pipetting -> this is what will be used for identification of:
  # - Samples (Sample 1-4)
  # - associated target genes
  # - reference gene location
  
  
 
  platemapMastermix <- NA
  platemapPrimer <- NA
  
  if(robot)
  {
     # load MASTERMIX sheet, which contains the Sample information and the layout where which sample is
  # Sample = Sample Name
  # Rack.Position = where to pipet from
  # q_PCR_Well_Pos = where to pipet to (final plate)
  #
    platemapMastermix <- as.data.frame(xlsx_mastermix)
    platemapMastermix <- dplyr::mutate(platemapMastermix,
                   Row=as.numeric(match(toupper(substr(q_PCR_Well_Pos, 1, 1)), LETTERS)),
                   Column=as.numeric(substr(q_PCR_Well_Pos, 2, 5)))
    
      # Primer Plate - tells us which target genes
  # Type = Target gene
  # Rack.Position = from where it takes the primer set
  # q_PCR_Plate = to where it pipettes (final plate)
  # Sample = Sample1 to Sample 4 -> same as in MasterMix Plate
  # Replicate = Which technical Replicate
  platemapPrimer <- dplyr::mutate(xlsx_primer,
                   Row=as.numeric(match(toupper(substr(q_PCR_Well_Pos, 1, 1)), LETTERS)),
                   Column=as.numeric(substr(q_PCR_Well_Pos, 2, 5)))
    
  }
  
  
  # Occupiedl well by Samples
  plot_occupied <- function(data = NULL,title="", save=FALSE){
    if(!is.na(data))
    {
       g <- ggplot(data=data, aes(x=Column, y=Row)) +
    geom_point(data=expand.grid(seq(1, 24), seq(1, 16)), aes(x=Var1, y=Var2),
               color="grey90", fill="white", shape=21, size=6) +
    geom_point(size=10) +
    coord_fixed(ratio=(13/12)/(9/8), xlim=c(0.5, 24.5), ylim=c(0.5, 16.5)) +
    scale_y_reverse(breaks=seq(1, 16), labels=LETTERS[1:16]) +
    scale_x_continuous(breaks=seq(1, 24)) +
    labs(title=title)
      
      return(g)
    } else {
      return(NULL)
    }
     
  }
  
  plot_target_overview <- function(data=NULL, title="Plate Layout: Target Genes", save=FALSE, samples=FALSE)
  {
    if(!is.na(data))
    {
      g <- ggplot(data=data, aes(x=Column, y=Row)) +
      geom_point(data=expand.grid(seq(1, 24), seq(1, 16)), aes(x=Var1, y=Var2),
                 color="grey90", fill="white", shape=21, size=6) 
      if(samples)
      {
        g <- g +  geom_point(aes(colour=Sample), size=6) 
      } else {
        g <- g + geom_point(aes(colour=Type), size=6) 
      }
      
      g <- g + coord_fixed(ratio=(13/12)/(9/8), xlim=c(0.5, 24.5), ylim=c(0.5, 16.5)) +
      scale_y_reverse(breaks=seq(1, 16), labels=LETTERS[1:16]) +
      scale_x_continuous(breaks=seq(1, 24)) +
      labs(title=title)
      return(g)
    } else {return(NULL)}
    
  }

  
  plot_occupied(data=platemapMastermix,title="Mastermix was added to the following wells", save=FALSE)
  
  # PLot Samples
  plot_target_overview(data = platemapMastermix, title = "Plate Layout: Samples", save=FALSE, samples=TRUE)
  
  

  
  plot_occupied(data=platemapPrimer,title="Primers were added to the following wells", save=FALSE)

  
  
  ## Plot Target genes
  
  
  plot_target_overview(data = platemapPrimer, title = "Plate Layout: Target Genes", save=FALSE)

  
  
  
  
  ## Plate qPCR RAW cq Value
  ### DONE LATER
  
  
  # Make df.pcr a nice df with the following stuff:
  # column names -> SAMPLE-TARGET_X with X being the replicate and SAMPLE being the Sample name as defined, TARGET being the target genes
  # SAMPLE comes from MASTERMIX, X and TARGET from primer
  ## STRUCTURE:
  # SAMPLE-GENE_REPLICATE
  df_samples <- NULL
  # make new DF
  if(robot)
  {
    df_samples <- tibble("Position" = xlsx_primer$q_PCR_Well_Pos,
         "Type" = xlsx_primer$Type,
         "Replicate" = xlsx_primer$Replicate
         )
    
  # add Sample information from xlsx_mastermix
  df_samples <- dplyr::left_join(x=df_samples, y = xlsx_mastermix, by=c("Position" = "q_PCR_Well_Pos"))
  
  df_samples$SampleFinal <-  apply(df_samples,1, function(x) {
      sample <- x[["Sample"]]
      replicate = x[["Replicate"]]
      gene = x[["Type"]]
      return(paste(sample,"-", gene, sep=""))
    })
    
  } else {
    df_samples <- tibble("Position" = overview_plate$overview$position,
         "Type" = overview_plate$overview$value,
         "Replicate" = overview_plate$overview$position
         )
    
    df_samples$SampleFinal <-  apply(df_samples,1, function(x) {
      sample <- sub(x = x[["Type"]], pattern = "(.*)_(.*)", replacement = "\\1")
      replicate = x[["Replicate"]]
      gene = sub(x = x[["Type"]], pattern = "(.*)_(.*)", replacement = "\\2")
      return(paste(sample,"-", gene, sep=""))
    })
    
  }
    
  
  # make df.pcr to have included information of samples
  #test <- df.pcr
  colnames(df.pcr) <- sub(pattern = "(\\w{1}\\d{1,2}).*", replacement = "\\1" , x = colnames(df.pcr) )
  
  #colnames_df.pcr <- colnames(df.pcr)
  # colnames(df.pcr) <- sapply(colnames(df.pcr), function(x) {
  #   sample <- dplyr::filter(df_samples, Position == x)$SampleFinal
  #   if(length(sample ==1))
  #   {
  #     return(sample)
  #   } else {
  #     return(x)
  #   }
  # })
  # 
  ncol(df.pcr)
  
 
str(df.pcr)

```


```{r calculate_CQ, include=FALSE}
ncol(df.pcr)

calc <- as.list(colnames(df.pcr[,2:ncol(df.pcr)]))
names(calc) <- colnames(df.pcr[,2:ncol(df.pcr)])
#length(colnames(df.pcr))
length(calc)

for(i in 1:length(calc))
{
  x <- names(calc)[i]
  out <- list()
  fitted <- try(qpcR::pcrfit(data = as.data.frame(df.pcr), 1, grep(pattern = paste("^",as.character(x),"$" , sep=""),x = colnames(df.pcr) ), model = l4 ))
  
  if(class(fitted) == "try-error")
      {
        out$fitted <- NA
        out$efficiency <- NA
        out$cq <- NA
      } else {
    # fitting worked
        out$fitted <- fitted
        efficiency = try(qpcR::efficiency(out$fitted, plot=FALSE, type = "Cy0"))
        if(class(efficiency) == "try-error")
        {
          out$efficiency <- NA
          out$cq <- NA
        } else {

          out$efficiency <- efficiency

           # Fourth: get calculated Cq or calculate Cq for Cy0
      if(cq_calc_method == "Cy0")
      {
        cq <- try(qpcR::Cy0(object = out$fitted, plot = FALSE))
        if(class(cq) == "try-error")
        {
          cq <- NA
        } else {
          out$cq <- cq
        }
      } else
      {
        out$cq <- out$efficiency[[cq_calc_method]]
      }
      }

      }
  # return
  calc[[i]] <- out
}
  
  
plot(calc$A2$fitted)
calc$A1$efficiency

qpcR::efficiency(calc$A1$fitted, plot=TRUE, type = "Cy0")

#calc
```

```{r OLDcalculation}

 # Calculation is done FOR ALL SAMPLES taking into account the replicate information!
  # we will make a list of samples
  ## TARGET Gene
  ##  # Sample (Type) <- for each gene a list
  ##  ## fitted <- will carry the fitting
  ##  ## cq <- will carry the calculated cq value (user selectable)
  ##  ## any additional element will be within the list either as separate list or DF or whatever
  # samples <- list()
  # samples <- as.list(unique(df_samples$Sample))
  # names(samples) <- unique(df_samples$Sample)
  # for (i in 1:length(samples))
  # {
  #   samples[[i]] <- unique(as.list(dplyr::filter(df_samples, Sample == names(samples)[i])$Type))
  #   names(samples[[i]]) <- unique(as.list(dplyr::filter(df_samples, Sample == names(samples)[i])$Type))
  # }
  
  # target <- list()
  # target <- as.list(unique(df_samples$Type))
  # names(target) <- unique(df_samples$Type)
  # for (i in 1:length(target))
  # {
  #   target[[i]] <- unique(as.list(dplyr::filter(df_samples, Type == names(target)[i])$Sample))
  #   names(target[[i]]) <- unique(as.list(dplyr::filter(df_samples, Type == names(target)[i])$Sample))
  # }
  
  # make factorizing for target/sample combination
  #vals <- colnames(df.pcr)[2:length(colnames(df.pcr))]
  #vals2 <- sub(pattern = "(.+)_", replacement = "\\1",x = vals)
  # SampleCombination is xxxx-xxxx_ and replicate is _y
  
  # # MODLIST usage first
  # qpcr_all_analysis <- qpcR::modlist(x = df.pcr, model=l4, check = NULL, remove="none", labels = colnames(vals))
  # qpcr_analysis <-  qpcR::replist(qpcr_all_analysis, group = gl(length(qpcr_all_analysis)/3, 3), check = "uni2", remove="KOD", names = "first")
  # 
  

  # Run analysis based on
  ## TARGET
  # get columns for each target
 
  # #length_reps <- seq.int(from = 1, to = length(df_samples$Type), by=1)
  # for(i in 1:length(target))
  # {
  #   print(target[i])
  #   # now go for each sample
  #   for(u in 1:length(target[[i]]))
  #   {
  #     
  #     print(target[[i]][u])
  #     # pattern for this particular combination, find where the combination is in the 384 well plate
  #     pattern <- paste(names(target[[i]])[u],"-", names(target)[i], ".*", sep="")
  #     # First: Perform a fit for EACH SAMPLE (replicate)
  #     target[[i]][[u]] <- list()
  #     fitted <- try(qpcR::pcrfit(data = as.data.frame(df.pcr), 1, grep(pattern = pattern,x = colnames(df.pcr) ), model = l4 ))
  #     if(class(fitted) == "try-error")
  #     {
  #       target[[i]][[u]]$fitted <- NA
  #       target[[i]][[u]]$efficiency <- NA
  #       target[[i]][[u]]$cq <- NA
  #     } else {
  #       
  #       target[[i]][[u]]$fitted <- fitted
  #       efficiency = try(qpcR::efficiency(target[[i]][[u]]$fitted, plot=FALSE, type = cq_calc_method))
  #       if(class(efficiency) == "try-error")
  #       {
  #         target[[i]][[u]]$efficiency <- NA
  #         target[[i]][[u]]$cq <- NA
  #       } else {
  #         
  #         target[[i]][[u]]$efficiency <- efficiency
  #       
  #          # Fourth: get calculated Cq or calculate Cq for Cy0
  #     if(cq_calc_method == "Cy0")
  #     {
  #       cq <- try(qpcR::Cy0(object = target[[i]][[u]]$fitted, plot = FALSE))
  #       if(class(cq) == "try-error")
  #       {
  #         cq <- NA
  #       } else {
  #         target[[i]][[u]]$cq <- cq
  #       }
  #     } else 
  #     {
  #       target[[i]][[u]]$cq <- target[[i]][[u]]$efficiency[[cq_calc_method]]
  #     }
  #     }
  #         
  #     }
  #       
  #    
  #     # Second: Plot Fits
  #     #plot(target[[i]][[u]]$fitted)
  #     #plot(target[[i]][u]$fitted)
  #     # Third: Plot PCR Efficiency
  #    
  #     
  #     
  #   }
  # }

  
  # write this back in a DF for HTQPCR for further analysis
  
#str(target)
#plot(target[[i]][[u]]$fitted)
#str(target[[i]][[u]]$efficiency)
#str(target[[i]][[u]]$cq)

```



```{r MeltingCurve}

str(df.melting)



```


```{r htqpcr1, include=FALSE}
# write calc list wiht all cq values to a tibble for htqpcr
cq <- lapply(calc,function(x){
  return(x[["cq"]])
})
cq_df <- as.data.frame(t(as.data.frame(cq)))
cq_df$Position <- rownames(cq_df)
colnames(cq_df) <- c("Cq", "Position")
df_samples <- dplyr::left_join(x=df_samples, y=cq_df, by="Position")

df_samples$Control <- df_samples$Type
df_samples$Control[df_samples$Control != calibrator] <- "Target"
df_samples$Control[df_samples$Control == calibrator] <- "Endogenous Control"

# FILTERING STEP
# input$filterhigh <- 35
# input$filterlow <- 5
filterhigh <- 35
filterlow <- 5

df_samples$Cq[df_samples$Cq >= filterhigh | df_samples$Cq <= filterlow] <- NA

View(df_samples)
str(df_samples)
# path <- system.file("exData", package = "HTqPCR")
# head(read.delim(file.path(path, "files.txt")))
# 
# files <- read.delim(file.path(path, "files.txt"))
# readr::read_tsv(file.path(path, files$File[1]),col_names = FALSE)
# raw <- readCtData(files = files$File, path = path)

# raw

output_cqdata <- df_samples[, c("Position", "Type", "Sample", "Cq", "Control")]



n_samples <- unique(output_cqdata$Sample)
n_samples <- n_samples[!is.na(n_samples)]

n_features <- nrow(dplyr::filter(df_samples, Sample == n_samples[1]) %>% dplyr::select( Position))
# 
for(i in 1:length(n_samples))
{
  
  fullplate_df <- NULL
  pos1 <- dplyr::filter(df_samples, Sample == n_samples[i]) %>% dplyr::select( Position)
  fullplate_df <- tibble("Position" = pos1$Position)
  fullplate_df <- dplyr::left_join(fullplate_df, dplyr::filter(output_cqdata, Sample == n_samples[i]))
  #fullplate_df <- dplyr::filter(output_cqdata, Sample == n_samples[i]) %>% dplyr::arrange(Type)
  pos <- dplyr::filter(df_samples, Sample == n_samples[1]) %>% dplyr::select( Position)
  fullplate_df$Position <- pos$Position
  # fullplate_df <- dplyr::full_join(fullplate_df, dplyr::select(df_samples, Position), by= "Position")
  fullplate_df <- dplyr::arrange(fullplate_df,Type)
  #readr::write_tsv(x = dplyr::filter(output_cqdata, Sample == n_samples[i]), path = file.path(getwd(), n_samples[i]), col_names = FALSE)
  readr::write_tsv(x = fullplate_df, path = file.path(getwd(), n_samples[i]), col_names = FALSE)
}

# config$userDir
#readr::write_tsv(x = output_cqdata, path = file.path(getwd(), n_samples[1]), col_names = FALSE)

# read back in for htqpcr as qcprdataset
qPCRraw <- HTqPCR::readCtData(files = n_samples, path=getwd(), column.info = list("position" = 1,"feature" = 2,"Ct" = 4, "type"=5), n.features = n_features)
# 

#readr::write_tsv(x = output_cqdata, path = file.path(getwd(), "test"), col_names = FALSE)

#qPCRraw <- HTqPCR::readCtData(files = "test", path=getwd(), column.info = list("position" = 1,"feature" = 2, "Ct" = 4, "type" = 5), n.features = nrow(df_samples))

#plotCtCard(qPCRraw, col.range = c(10, 35), well.size = 2)

#sample3.order <- rep(c(n_samples), each = length(unique(df_samples$Type)))
#qPCRnew2 <- changeCtLayout(sr.norm, sample.order = sample3.order)

plotCtOverview(qPCRraw, genes = unique(df_samples$Type), groups = sampleNames(qPCRraw) , conf.int = TRUE)

#plotCtReps(qPCRraw,card=1, percent=1)

raw.mix <- qPCRraw
plotCtVariation(raw.mix, variation = "sd", log = TRUE, main = "SD of replicated features", col = "lightgrey")

raw.variation <- plotCtVariation(raw.mix, type = "detail", add.featurenames = TRUE, pch = " ", cex = 1.2)

# if featureClass or featureType is set
featureClass(qPCRraw)
featureCategory(qPCRraw)
#raw.cat <- qPCRraw
#plotCtCategory(raw.cat)
#plotCtCategory(raw.cat, stratify = "class")

#plotCtCategory(raw.cat, by.feature = TRUE, cexRow = 0.1)

## make own qPCR data set

# Making pesudo-data, just to illustrate the example



#### NORMALIZE DATA

?normalizeCtData

g.norm <- normalizeCtData(qPCRraw, norm = "deltaCt", Ct.max = 35, deltaCt.genes = c("GAPDH","PGK1"))

plot(exprs(qPCRraw), exprs(g.norm), pch = 20, main = "deltaCT normalisation", col = rep(brewer.pal(6, "Spectral"), each = 96))


plotCtCor(qPCRraw, main = "Ct correlation")
plotCtCor(g.norm, main = "Ct correlation")
plotCtDensity(g.norm)


plotCtOverview(g.norm, genes = unique(df_samples$Type), groups = sampleNames(qPCRraw) , conf.int = TRUE)
plotCtBoxes(g.norm)

plotCtScatter(g.norm, cards = c(1, 3), col = "type", diag = TRUE)
plotCtPairs(g.norm, col = "type", diag = TRUE)

plotCtPCA(qPCRraw)

plotCtHeatmap(qPCRraw, gene.names = "", dist = "euclidean")
plotCtHeatmap(g.norm, gene.names = "", dist = "euclidean")

clusterCt(g.norm, type = "samples")
clusterCt(g.norm, type = "genes")

plotCtRQ()
# get number of genes
numGenes <- length(unique(df_samples$Type))

# get number of samples
numSamples <-  length(unique(output_cqdata$Sample))


# for(i in 1:length(n_samples))
# {
#   if(i == 1)
#   {
#     df_temp <- dplyr::filter(df_samples, Sample==n_samples[i]) %>% dplyr::select(Type, Cq)
#     
#   } else {
#     df_temp <- dplyr::bind_cols(df_temp,dplyr::filter(df_samples, Sample==n_samples[i]) %>% dplyr::select(Cq) )
#     #df_temp <- dplyr::bind_cols(x=df_temp, y = dplyr::filter(df_samples, Sample==n_samples[i]) %>% dplyr::select(Type, Cq), by = c("Genes"="Type") )
#   }
#   
# }
# colnames(df_temp) <- c("Genes", n_samples)
# 
# # Make qPCRset object
# qPCRraw   <- new("qPCRset",
#         exprs=as.matrix(dplyr::select(df_temp, 2:(length(n_samples)+1) ))
#         #featureNames=as.vector(df_temp$Genes)
#         #sampleNames=n_samples
#        )

featureNames(qPCRraw) <- df_temp$Genes
sampleNames(qPCRraw) <- n_samples
featurePos(qPCRraw) <- df_temp$
featuretypes <- dplyr::filter(df_samples, Sample == n_samples[1]) %>% dplyr::select(Type)
featuretypes[featuretypes != calibrator] <- "Target"
featuretypes[featuretypes == calibrator] <- "Reference Gene"

featureType(qPCRraw) <- featuretypes


qPCRraw

slotNames(qPCRraw)
phenoData(qPCRraw)

pData(qPCRraw)
featureData(qPCRraw)
featureType(qPCRraw)

head(fData(qPCRraw))


getCt(qPCRraw)
featureNames(qPCRraw)
sampleNames(qPCRraw)


 
 # select GENES
 g <- unique(df_samples$Type) #(max 20!)
 # select SAMPLES
 group <- n_samples
 plotCtOverview(qPCRraw, genes = g, groups = group, conf.int = TRUE)
 #?plotCtOverview
 #plotCtOverview(qPCRraw, genes = g, groups = group, calibrator = "Sample1") # calibrator must be sample!

 g
 
plotCtReps(qPCRraw,card = 1, percent = 10,verbose = TRUE)
?plotCtReps


# Load example data
data(qPCRraw)
featureType(qPCRraw)
# Plot replicates
plotCtReps(qPCRraw, percent=1)
plotCtReps(qPCRraw, card=2, percent=10)
reps <- plotCtReps(qPCRraw, card=2, percent=20)
reps

```


```{r Plots}

########## PLATE QC and OVERVIEW

plot_platemap_overview(data=platemap)

## ONLY AVAILABLE IF ROBOT ==TRUE
## occupied wells acccording to mixing
plot_occupied(data=platemapMastermix,title="Mastermix was added to the following wells", save=FALSE)

plot_target_overview(data = platemapMastermix, title = "Plate Layout: Samples", save=FALSE, samples=TRUE)
  
plot_occupied(data=platemapPrimer,title="Primers were added to the following wells", save=FALSE)

## Plot Target genes according to robot
plot_target_overview(data = platemapPrimer, title = "Plate Layout: Target Genes", save=FALSE)



######### Individual wells

## for each unique sample including three replicates
## QC ONLY!!
## user can select a sample and  and plots ar created as QC using the well information FROM SAMPLEFINAL, e.g. combination of sample and target gene

userselect <- "Sample1-ADAM10"

pos <- dplyr::filter(df_samples, SampleFinal == userselect) %>% dplyr::select(Position)

# # plot RAW fluorescences
# plot_raw <- function(data=NA, pos=NULL)
# {
#   if(!is.na(data) && !is.null(pos))
#   {
#     for(i in 1:length(pos))
#     {
#       plot(data[[pos[i]]]$fitted)
#     }
#   } else { return(NULL)}
# }
# 
# plot_raw(calc, pos=pos$Position)

# Plot fitting and cq calculation
plot_cq_fitted <- function(data=NA, pos=NULL, cq=cq_calc_method)
{
  if(!is.na(data) && !is.null(pos) &&!is.na(cq_calc_method))
  {
    for(i in 1:length(pos))
    {
      qpcR::efficiency(data[[pos[i]]]$fitted, plot=TRUE, type = cq_calc_method)
    }
  } else { return(NULL)}
  
}

par(mfrow=c(2,2))
plot_cq_fitted(data=calc, pos=pos$Position, cq = cq_calc_method)

## for each Sample give a overview of all gene
# cq values

userselect_sample <- "Sample1"

df_samples

cq_plot <- dplyr::filter(df_samples, Sample == userselect_sample) %>% dplyr::select(Cq)


## for each target gene give an overview of all sample
# cq values

```




```{r tables}

## Overview table

df_samples


## 




```
