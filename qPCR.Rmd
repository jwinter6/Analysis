---
title: "qPCR Analysis"
output: html_notebook
---

# Load and convert rawdata from LC480

```{r loaddata}

library(qpcR)
library(tibble)
library(readr)
library(dplyr)
library(openxlsx)
library(ggplot2)

## GENERAL

# Sample1 , Sample2, Sample3 and Sample4 are used as generic placeholders
# this needs to be renamed in interface to the actual sample name, and then replaced in the Dataset

# ##Inputs:
# sample list
samplelist <- list("Sample1" = "1", "Sample2" = "2", "Sample3" = "3", "Sample4" = "4")

#qPCR rawdata
file <- "/Users/janwinter/OneDrive/PhD/Followup/Results/qPCR/2017-03-20_TEST_Primers/data/JW_20170321_qPCR_TestPrimer.txt"


# XSLX overview file
file_xlsx <- "/Users/janwinter/OneDrive/PhD/Followup/Results/qPCR/2017-03-20_TEST_Primers/2017-03-20_qPCR_TEST_cDNASynthesis.xlsx"

# read file data 
file.read <- readr::read_tsv(file = file, col_names = c("SamplePos","SampleName","Prog","Seg","Cycle","Time","Temp","483-533"), skip = 2)


# convert to qpcR format flat file
## each row -> CYCLE
## each column -> Well

## make new tibble with maximum number of cycles
df.pcr <- tibble::tibble("Cycles" = seq(from = min(file.read[,"Cycle"]), to = max(file.read[,"Cycle"]), by =1))

## Add names (unique ones of course) as columns, so we first make data frame for each Well that contains cycles 1-x and the 483-533 value

wells <- as.list(unique(file.read$SamplePos))
names(wells) <- unique(file.read$SamplePos)


#dplyr::filter(file.read, SamplePos == "A1" & Prog == 2)  %>% dplyr::select(2,3, 5, 8)


df.data <- lapply(wells, function(x){
  # get subset
  subset <- dplyr::filter(file.read, SamplePos == as.character(x) & Prog == 2)  %>% dplyr::select( 5, 8)
  # Get column 483-533
  #subset <- dplyr::select(subset, 5, 8)
  colnames(subset) <- c("Cycles",as.character(x))
  # Add to tibble
  df.pcr <<- dplyr::left_join(df.pcr, subset, by = "Cycles")
  return(subset)
  
})

df.data <- NULL
# df.pcr will store all information in a flat-file way for qPCR anakysis
# rows -> cycles
# columns <- wells
df.pcr



## get melting curve information (Prog == 3 in data)
df.melting <- tibble::tibble("Temp" = unique(file.read[file.read$Prog == 3, "Temp"]$Temp))
#t <- dplyr::filter(file.read, SamplePos == "A1" & Prog == 3)  %>% dplyr::select( 7, 8)
#df.melting <<- dplyr::left_join(df.melting, t, by = "Temp")


df.data <- lapply(wells, function(x){
  # get subset
  subset <- dplyr::filter(file.read, SamplePos == as.character(x) & Prog == 3)  %>% dplyr::select( 7, 8)
  # Get column 483-533
  #subset <- dplyr::select(subset, 5, 8)
  colnames(subset) <- c("Temp",as.character(x))
  # Add to tibble
  df.melting <<- dplyr::left_join(df.melting, subset, by = "Temp")
  return(subset)
  
})


## AVAILABLE DATA STRUCTURES
# file.read -> qPCR raw data
# df.pcr -> flat-file qPCR rawdata in qpcR format
# df.melting -> flat-file qPCR melting curve data (temp vs fluorescence)

# load annotation data

xlsx_mastermix <- openxlsx::read.xlsx(file_xlsx, sheet = "Mastermix")
xlsx_primer <- openxlsx::read.xlsx(file_xlsx, sheet = "cDNA")
xlsx_overview <- as.data.frame(openxlsx::read.xlsx(file_xlsx, sheet = "qPCR Overview", colNames = TRUE, rowNames = TRUE), stringsAsFactors = FALSE)


# Replace Sample with user names
  
  for(i in 1:length(samplelist))
  {
    xlsx_mastermix$Sample <- sub(pattern = names(samplelist)[i],replacement = samplelist[[i]],x = xlsx_mastermix$Sample)
    xlsx_primer$Sample <- sub(pattern = names(samplelist)[i],replacement = samplelist[[i]],x = xlsx_primer$Sample)
  }

# get Overview plate first

overview_plate <- list()
overview_plate$overview <- reshape2::melt(as.matrix(xlsx_overview))
pattern <- expression("^(\\d{1})$")
overview_plate$overview$Var2 <- sub(pattern = pattern, replacement = paste("0","\\1", sep=""), x=  overview_plate$overview$Var2, fixed = FALSE )
overview_plate$overview$position <- paste0(overview_plate$overview$Var1, overview_plate$overview$Var2)

## make ggplot2 image
platemap <- dplyr::mutate(as.data.frame(overview_plate$overview),
                   Row=as.numeric(match(toupper(substr(position, 1, 1)), LETTERS)),
                   Column=as.numeric(substr(position, 2, 5)))
g <- ggplot2::ggplot(data=platemap, aes(x=Column, y=Row)) +
    geom_point(data=expand.grid(seq(1, 24), seq(1, 16)), aes(x=Var1, y=Var2),
               color="grey90", fill="white", shape=21, size=6) +
    geom_point(aes(color=value), size=6) +
    coord_fixed(ratio=(26/24)/(18/16), xlim=c(0.5, 25), ylim=c(0.5, 17)) +
    scale_y_reverse(breaks=seq(1, 16), labels=LETTERS[1:16]) +
    scale_x_continuous(breaks=seq(1, 24)) +
  scale_shape_manual(values=seq(from=0, to = length(unique(platemap$value)), by=1 ) ) +
    labs(title="Overview plate: Target Genes") 
  
  print(g)


  
  ### Get info from cDNA and Mastermix plate for Overview the robot is pipetting -> this is what will be used for identification of:
  # - Samples (Sample 1-4)
  # - associated target genes
  # - reference gene location
  
  
  # load MASTERMIX sheet, which contains the Sample information and the layout where which sample is
  # Sample = Sample Name
  # Rack.Position = where to pipet from
  # q_PCR_Well_Pos = where to pipet to (final plate)
  #
  
  platemapMastermix <- as.data.frame(xlsx_mastermix)
  platemapMastermix <- dplyr::mutate(platemapMastermix,
                   Row=as.numeric(match(toupper(substr(q_PCR_Well_Pos, 1, 1)), LETTERS)),
                   Column=as.numeric(substr(q_PCR_Well_Pos, 2, 5)))
  
  # Occupiedl well by Samples
  plot_occupied <- function(data = NULL,title="", save=FALSE){
    
      g <- ggplot(data=data, aes(x=Column, y=Row)) +
    geom_point(data=expand.grid(seq(1, 24), seq(1, 16)), aes(x=Var1, y=Var2),
               color="grey90", fill="white", shape=21, size=6) +
    geom_point(size=10) +
    coord_fixed(ratio=(13/12)/(9/8), xlim=c(0.5, 24.5), ylim=c(0.5, 16.5)) +
    scale_y_reverse(breaks=seq(1, 16), labels=LETTERS[1:16]) +
    scale_x_continuous(breaks=seq(1, 24)) +
    labs(title=title)
      
      return(g)
  }
  
  plot_target_overview <- function(data=NULL, title="Plate Layout: Target Genes", save=FALSE, samples=FALSE)
  {
    g <- ggplot(data=data, aes(x=Column, y=Row)) +
    geom_point(data=expand.grid(seq(1, 24), seq(1, 16)), aes(x=Var1, y=Var2),
               color="grey90", fill="white", shape=21, size=6) 
    if(samples)
    {
      g <- g +  geom_point(aes(colour=Sample), size=6) 
    } else {
      g <- g + geom_point(aes(colour=Type), size=6) 
    }
    
    g <- g + coord_fixed(ratio=(13/12)/(9/8), xlim=c(0.5, 24.5), ylim=c(0.5, 16.5)) +
    scale_y_reverse(breaks=seq(1, 16), labels=LETTERS[1:16]) +
    scale_x_continuous(breaks=seq(1, 24)) +
    labs(title=title)
    return(g)
  }

  
  plot_occupied(data=platemapMastermix,title="Mastermix was added to the following wells", save=FALSE)
  
  # PLot Samples
  plot_target_overview(data = platemapMastermix, title = "Plate Layout: Samples", save=FALSE, samples=TRUE)
  
  
  # Primer Plate - tells us which target genes
  # Type = Target gene
  # Rack.Position = from where it takes the primer set
  # q_PCR_Plate = to where it pipettes (final plate)
  # Sample = Sample1 to Sample 4 -> same as in MasterMix Plate
  # Replicate = Which technical Replicate
  platemapPrimer <- dplyr::mutate(xlsx_primer,
                   Row=as.numeric(match(toupper(substr(q_PCR_Well_Pos, 1, 1)), LETTERS)),
                   Column=as.numeric(substr(q_PCR_Well_Pos, 2, 5)))
  
  plot_occupied(data=platemapPrimer,title="Primers were added to the following wells", save=FALSE)

  
  
  ## Plot Target genes
  
  
  plot_target_overview(data = platemapPrimer, title = "Plate Layout: Target Genes", save=FALSE)

  
  
  

```




